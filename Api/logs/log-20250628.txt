2025-06-28 22:19:44.154 +07:00 [FTL] Application terminated unexpectedly
System.AggregateException: Some services are not able to be constructed (Error while validating the service descriptor 'ServiceType: Application.Services.OrderService Lifetime: Scoped ImplementationType: Application.Services.OrderService': Unable to resolve service for type 'Domain.Repositories.IOrderPaymentRepository' while attempting to activate 'Application.Services.OrderService'.) (Error while validating the service descriptor 'ServiceType: Application.UseCases.InitialOrderUseCase Lifetime: Scoped ImplementationType: Application.UseCases.InitialOrderUseCase': Unable to resolve service for type 'Domain.Repositories.IOrderPaymentRepository' while attempting to activate 'Application.Services.OrderService'.)
 ---> System.InvalidOperationException: Error while validating the service descriptor 'ServiceType: Application.Services.OrderService Lifetime: Scoped ImplementationType: Application.Services.OrderService': Unable to resolve service for type 'Domain.Repositories.IOrderPaymentRepository' while attempting to activate 'Application.Services.OrderService'.
 ---> System.InvalidOperationException: Unable to resolve service for type 'Domain.Repositories.IOrderPaymentRepository' while attempting to activate 'Application.Services.OrderService'.
   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteFactory.CreateArgumentCallSites(ServiceIdentifier serviceIdentifier, Type implementationType, CallSiteChain callSiteChain, ParameterInfo[] parameters, Boolean throwIfCallSiteNotFound)
   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteFactory.CreateConstructorCallSite(ResultCache lifetime, ServiceIdentifier serviceIdentifier, Type implementationType, CallSiteChain callSiteChain)
   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteFactory.TryCreateExact(ServiceDescriptor descriptor, ServiceIdentifier serviceIdentifier, CallSiteChain callSiteChain, Int32 slot)
   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteFactory.GetCallSite(ServiceDescriptor serviceDescriptor, CallSiteChain callSiteChain)
   at Microsoft.Extensions.DependencyInjection.ServiceProvider.ValidateService(ServiceDescriptor descriptor)
   --- End of inner exception stack trace ---
   at Microsoft.Extensions.DependencyInjection.ServiceProvider.ValidateService(ServiceDescriptor descriptor)
   at Microsoft.Extensions.DependencyInjection.ServiceProvider..ctor(ICollection`1 serviceDescriptors, ServiceProviderOptions options)
   --- End of inner exception stack trace ---
   at Microsoft.Extensions.DependencyInjection.ServiceProvider..ctor(ICollection`1 serviceDescriptors, ServiceProviderOptions options)
   at Microsoft.Extensions.DependencyInjection.ServiceCollectionContainerBuilderExtensions.BuildServiceProvider(IServiceCollection services, ServiceProviderOptions options)
   at Microsoft.Extensions.Hosting.HostApplicationBuilder.<>c__DisplayClass12_0.<.ctor>b__0()
   at Microsoft.Extensions.Hosting.HostApplicationBuilder.Build()
   at Microsoft.AspNetCore.Builder.WebApplicationBuilder.Build()
   at Program.<Main>$(String[] args) in /Users/tostyle/Project/Kingpower/poc/OrderDotnet/Api/Program.cs:line 45
 ---> (Inner Exception #1) System.InvalidOperationException: Error while validating the service descriptor 'ServiceType: Application.UseCases.InitialOrderUseCase Lifetime: Scoped ImplementationType: Application.UseCases.InitialOrderUseCase': Unable to resolve service for type 'Domain.Repositories.IOrderPaymentRepository' while attempting to activate 'Application.Services.OrderService'.
 ---> System.InvalidOperationException: Unable to resolve service for type 'Domain.Repositories.IOrderPaymentRepository' while attempting to activate 'Application.Services.OrderService'.
   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteFactory.CreateArgumentCallSites(ServiceIdentifier serviceIdentifier, Type implementationType, CallSiteChain callSiteChain, ParameterInfo[] parameters, Boolean throwIfCallSiteNotFound)
   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteFactory.CreateConstructorCallSite(ResultCache lifetime, ServiceIdentifier serviceIdentifier, Type implementationType, CallSiteChain callSiteChain)
   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteFactory.TryCreateExact(ServiceDescriptor descriptor, ServiceIdentifier serviceIdentifier, CallSiteChain callSiteChain, Int32 slot)
   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteFactory.TryCreateExact(ServiceIdentifier serviceIdentifier, CallSiteChain callSiteChain)
   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteFactory.CreateCallSite(ServiceIdentifier serviceIdentifier, CallSiteChain callSiteChain)
   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteFactory.GetCallSite(ServiceIdentifier serviceIdentifier, CallSiteChain callSiteChain)
   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteFactory.CreateArgumentCallSites(ServiceIdentifier serviceIdentifier, Type implementationType, CallSiteChain callSiteChain, ParameterInfo[] parameters, Boolean throwIfCallSiteNotFound)
   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteFactory.CreateConstructorCallSite(ResultCache lifetime, ServiceIdentifier serviceIdentifier, Type implementationType, CallSiteChain callSiteChain)
   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteFactory.TryCreateExact(ServiceDescriptor descriptor, ServiceIdentifier serviceIdentifier, CallSiteChain callSiteChain, Int32 slot)
   at Microsoft.Extensions.DependencyInjection.ServiceLookup.CallSiteFactory.GetCallSite(ServiceDescriptor serviceDescriptor, CallSiteChain callSiteChain)
   at Microsoft.Extensions.DependencyInjection.ServiceProvider.ValidateService(ServiceDescriptor descriptor)
   --- End of inner exception stack trace ---
   at Microsoft.Extensions.DependencyInjection.ServiceProvider.ValidateService(ServiceDescriptor descriptor)
   at Microsoft.Extensions.DependencyInjection.ServiceProvider..ctor(ICollection`1 serviceDescriptors, ServiceProviderOptions options)<---

2025-06-28 22:20:52.377 +07:00 [FTL] Application terminated unexpectedly
Npgsql.PostgresException (0x80004005): 28P01: password authentication failed for user "postgres"
   at Npgsql.Internal.NpgsqlConnector.ReadMessageLong(Boolean async, DataRowLoadingMode dataRowLoadingMode, Boolean readingNotifications, Boolean isReadingPrependedMessage)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource<TResult>.GetResult(Int16 token)
   at Npgsql.Internal.NpgsqlConnector.AuthenticateSASL(List`1 mechanisms, String username, Boolean async, CancellationToken cancellationToken)
   at Npgsql.Internal.NpgsqlConnector.Authenticate(String username, NpgsqlTimeout timeout, Boolean async, CancellationToken cancellationToken)
   at Npgsql.Internal.NpgsqlConnector.<Open>g__OpenCore|214_1(NpgsqlConnector conn, SslMode sslMode, NpgsqlTimeout timeout, Boolean async, CancellationToken cancellationToken)
   at Npgsql.Internal.NpgsqlConnector.Open(NpgsqlTimeout timeout, Boolean async, CancellationToken cancellationToken)
   at Npgsql.UnpooledDataSource.Get(NpgsqlConnection conn, NpgsqlTimeout timeout, Boolean async, CancellationToken cancellationToken)
   at Npgsql.NpgsqlConnection.<Open>g__OpenAsync|42_0(Boolean async, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalConnection.OpenInternalAsync(Boolean errorsExpected, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalConnection.OpenInternalAsync(Boolean errorsExpected, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalConnection.OpenAsync(CancellationToken cancellationToken, Boolean errorsExpected)
   at Npgsql.EntityFrameworkCore.PostgreSQL.Storage.Internal.NpgsqlDatabaseCreator.Exists(Boolean async, CancellationToken cancellationToken)
   at Npgsql.EntityFrameworkCore.PostgreSQL.Storage.Internal.NpgsqlDatabaseCreator.Exists(Boolean async, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalDatabaseCreator.EnsureCreatedAsync(CancellationToken cancellationToken)
   at Infrastructure.Extensions.InfrastructureServiceExtensions.EnsureDatabaseCreatedAsync(IServiceProvider serviceProvider) in /Users/tostyle/Project/Kingpower/poc/OrderDotnet/Infrastructure/Extensions/InfrastructureServiceExtensions.cs:line 72
   at Program.<Main>$(String[] args) in /Users/tostyle/Project/Kingpower/poc/OrderDotnet/Api/Program.cs:line 70
  Exception data:
    Severity: FATAL
    SqlState: 28P01
    MessageText: password authentication failed for user "postgres"
    File: auth.c
    Line: 323
    Routine: auth_failed
2025-06-28 22:22:02.626 +07:00 [FTL] Application terminated unexpectedly
Npgsql.PostgresException (0x80004005): 28P01: password authentication failed for user "postgres"
   at Npgsql.Internal.NpgsqlConnector.ReadMessageLong(Boolean async, DataRowLoadingMode dataRowLoadingMode, Boolean readingNotifications, Boolean isReadingPrependedMessage)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource<TResult>.GetResult(Int16 token)
   at Npgsql.Internal.NpgsqlConnector.AuthenticateSASL(List`1 mechanisms, String username, Boolean async, CancellationToken cancellationToken)
   at Npgsql.Internal.NpgsqlConnector.Authenticate(String username, NpgsqlTimeout timeout, Boolean async, CancellationToken cancellationToken)
   at Npgsql.Internal.NpgsqlConnector.<Open>g__OpenCore|214_1(NpgsqlConnector conn, SslMode sslMode, NpgsqlTimeout timeout, Boolean async, CancellationToken cancellationToken)
   at Npgsql.Internal.NpgsqlConnector.Open(NpgsqlTimeout timeout, Boolean async, CancellationToken cancellationToken)
   at Npgsql.UnpooledDataSource.Get(NpgsqlConnection conn, NpgsqlTimeout timeout, Boolean async, CancellationToken cancellationToken)
   at Npgsql.NpgsqlConnection.<Open>g__OpenAsync|42_0(Boolean async, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalConnection.OpenInternalAsync(Boolean errorsExpected, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalConnection.OpenInternalAsync(Boolean errorsExpected, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalConnection.OpenAsync(CancellationToken cancellationToken, Boolean errorsExpected)
   at Npgsql.EntityFrameworkCore.PostgreSQL.Storage.Internal.NpgsqlDatabaseCreator.Exists(Boolean async, CancellationToken cancellationToken)
   at Npgsql.EntityFrameworkCore.PostgreSQL.Storage.Internal.NpgsqlDatabaseCreator.Exists(Boolean async, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalDatabaseCreator.EnsureCreatedAsync(CancellationToken cancellationToken)
   at Infrastructure.Extensions.InfrastructureServiceExtensions.EnsureDatabaseCreatedAsync(IServiceProvider serviceProvider) in /Users/tostyle/Project/Kingpower/poc/OrderDotnet/Infrastructure/Extensions/InfrastructureServiceExtensions.cs:line 72
   at Program.<Main>$(String[] args) in /Users/tostyle/Project/Kingpower/poc/OrderDotnet/Api/Program.cs:line 70
  Exception data:
    Severity: FATAL
    SqlState: 28P01
    MessageText: password authentication failed for user "postgres"
    File: auth.c
    Line: 323
    Routine: auth_failed
2025-06-28 22:22:37.948 +07:00 [FTL] Application terminated unexpectedly
Npgsql.PostgresException (0x80004005): 28P01: password authentication failed for user "postgres"
   at Npgsql.Internal.NpgsqlConnector.ReadMessageLong(Boolean async, DataRowLoadingMode dataRowLoadingMode, Boolean readingNotifications, Boolean isReadingPrependedMessage)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource<TResult>.GetResult(Int16 token)
   at Npgsql.Internal.NpgsqlConnector.AuthenticateSASL(List`1 mechanisms, String username, Boolean async, CancellationToken cancellationToken)
   at Npgsql.Internal.NpgsqlConnector.Authenticate(String username, NpgsqlTimeout timeout, Boolean async, CancellationToken cancellationToken)
   at Npgsql.Internal.NpgsqlConnector.<Open>g__OpenCore|214_1(NpgsqlConnector conn, SslMode sslMode, NpgsqlTimeout timeout, Boolean async, CancellationToken cancellationToken)
   at Npgsql.Internal.NpgsqlConnector.Open(NpgsqlTimeout timeout, Boolean async, CancellationToken cancellationToken)
   at Npgsql.UnpooledDataSource.Get(NpgsqlConnection conn, NpgsqlTimeout timeout, Boolean async, CancellationToken cancellationToken)
   at Npgsql.NpgsqlConnection.<Open>g__OpenAsync|42_0(Boolean async, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalConnection.OpenInternalAsync(Boolean errorsExpected, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalConnection.OpenInternalAsync(Boolean errorsExpected, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalConnection.OpenAsync(CancellationToken cancellationToken, Boolean errorsExpected)
   at Npgsql.EntityFrameworkCore.PostgreSQL.Storage.Internal.NpgsqlDatabaseCreator.Exists(Boolean async, CancellationToken cancellationToken)
   at Npgsql.EntityFrameworkCore.PostgreSQL.Storage.Internal.NpgsqlDatabaseCreator.Exists(Boolean async, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalDatabaseCreator.EnsureCreatedAsync(CancellationToken cancellationToken)
   at Infrastructure.Extensions.InfrastructureServiceExtensions.EnsureDatabaseCreatedAsync(IServiceProvider serviceProvider) in /Users/tostyle/Project/Kingpower/poc/OrderDotnet/Infrastructure/Extensions/InfrastructureServiceExtensions.cs:line 72
   at Program.<Main>$(String[] args) in /Users/tostyle/Project/Kingpower/poc/OrderDotnet/Api/Program.cs:line 70
  Exception data:
    Severity: FATAL
    SqlState: 28P01
    MessageText: password authentication failed for user "postgres"
    File: auth.c
    Line: 323
    Routine: auth_failed
2025-06-28 22:23:03.950 +07:00 [FTL] Application terminated unexpectedly
Npgsql.PostgresException (0x80004005): 28P01: password authentication failed for user "postgres"
   at Npgsql.Internal.NpgsqlConnector.ReadMessageLong(Boolean async, DataRowLoadingMode dataRowLoadingMode, Boolean readingNotifications, Boolean isReadingPrependedMessage)
   at System.Runtime.CompilerServices.PoolingAsyncValueTaskMethodBuilder`1.StateMachineBox`1.System.Threading.Tasks.Sources.IValueTaskSource<TResult>.GetResult(Int16 token)
   at Npgsql.Internal.NpgsqlConnector.AuthenticateSASL(List`1 mechanisms, String username, Boolean async, CancellationToken cancellationToken)
   at Npgsql.Internal.NpgsqlConnector.Authenticate(String username, NpgsqlTimeout timeout, Boolean async, CancellationToken cancellationToken)
   at Npgsql.Internal.NpgsqlConnector.<Open>g__OpenCore|214_1(NpgsqlConnector conn, SslMode sslMode, NpgsqlTimeout timeout, Boolean async, CancellationToken cancellationToken)
   at Npgsql.Internal.NpgsqlConnector.Open(NpgsqlTimeout timeout, Boolean async, CancellationToken cancellationToken)
   at Npgsql.UnpooledDataSource.Get(NpgsqlConnection conn, NpgsqlTimeout timeout, Boolean async, CancellationToken cancellationToken)
   at Npgsql.NpgsqlConnection.<Open>g__OpenAsync|42_0(Boolean async, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalConnection.OpenInternalAsync(Boolean errorsExpected, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalConnection.OpenInternalAsync(Boolean errorsExpected, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalConnection.OpenAsync(CancellationToken cancellationToken, Boolean errorsExpected)
   at Npgsql.EntityFrameworkCore.PostgreSQL.Storage.Internal.NpgsqlDatabaseCreator.Exists(Boolean async, CancellationToken cancellationToken)
   at Npgsql.EntityFrameworkCore.PostgreSQL.Storage.Internal.NpgsqlDatabaseCreator.Exists(Boolean async, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalDatabaseCreator.EnsureCreatedAsync(CancellationToken cancellationToken)
   at Infrastructure.Extensions.InfrastructureServiceExtensions.EnsureDatabaseCreatedAsync(IServiceProvider serviceProvider) in /Users/tostyle/Project/Kingpower/poc/OrderDotnet/Infrastructure/Extensions/InfrastructureServiceExtensions.cs:line 72
   at Program.<Main>$(String[] args) in /Users/tostyle/Project/Kingpower/poc/OrderDotnet/Api/Program.cs:line 70
  Exception data:
    Severity: FATAL
    SqlState: 28P01
    MessageText: password authentication failed for user "postgres"
    File: auth.c
    Line: 323
    Routine: auth_failed
2025-06-28 22:23:18.975 +07:00 [INF] Executed DbCommand (23ms) [Parameters=[], CommandType='"Text"', CommandTimeout='30']
SELECT CASE WHEN COUNT(*) = 0 THEN FALSE ELSE TRUE END
FROM pg_class AS cls
JOIN pg_namespace AS ns ON ns.oid = cls.relnamespace
WHERE
        cls.relkind IN ('r', 'v', 'm', 'f', 'p') AND
        ns.nspname NOT IN ('pg_catalog', 'information_schema') AND
        -- Exclude tables which are members of PG extensions
        NOT EXISTS (
            SELECT 1 FROM pg_depend WHERE
                classid=(
                    SELECT cls.oid
                    FROM pg_class AS cls
                             JOIN pg_namespace AS ns ON ns.oid = cls.relnamespace
                    WHERE relname='pg_class' AND ns.nspname='pg_catalog'
                ) AND
                objid=cls.oid AND
                deptype IN ('e', 'x')
        )
2025-06-28 22:23:19.000 +07:00 [INF] Order Management API starting up...
2025-06-28 22:23:19.000 +07:00 [INF] Available endpoints:
2025-06-28 22:23:19.000 +07:00 [INF]   API endpoints have been removed - controller is empty
2025-06-28 22:23:19.050 +07:00 [INF] Now listening on: http://localhost:5208
2025-06-28 22:23:19.051 +07:00 [INF] Application started. Press Ctrl+C to shut down.
2025-06-28 22:23:19.051 +07:00 [INF] Hosting environment: Development
2025-06-28 22:23:19.052 +07:00 [INF] Content root path: /Users/tostyle/Project/Kingpower/poc/OrderDotnet/Api
2025-06-28 22:26:14.133 +07:00 [INF] Request starting HTTP/1.1 POST http://localhost:5208/api/orders - application/json 36
2025-06-28 22:26:14.153 +07:00 [WRN] Failed to determine the https port for redirect.
2025-06-28 22:26:14.156 +07:00 [INF] Executing endpoint 'Api.Controllers.OrdersController.CreateInitialOrder (Api)'
2025-06-28 22:26:14.178 +07:00 [INF] Route matched with {action = "CreateInitialOrder", controller = "Orders"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.ActionResult`1[Application.DTOs.InitialOrderResponse]] CreateInitialOrder(Application.DTOs.InitialOrderRequest, System.Threading.CancellationToken) on controller Api.Controllers.OrdersController (Api).
2025-06-28 22:26:14.688 +07:00 [INF] Executing action method Api.Controllers.OrdersController.CreateInitialOrder (Api) - Validation state: "Valid"
2025-06-28 22:26:14.689 +07:00 [INF] Creating initial order with ReferenceId: order-ref-001
2025-06-28 22:26:14.826 +07:00 [INF] Executed DbCommand (13ms) [Parameters=[@__referenceId_0='?'], CommandType='"Text"', CommandTimeout='30']
SELECT o."Id", o."CreatedAt", o."OrderState", o."ReferenceId", o."UpdatedAt", o."Version", o."WorkflowId"
FROM "Orders" AS o
WHERE o."ReferenceId" = @__referenceId_0
LIMIT 1
2025-06-28 22:26:14.829 +07:00 [WRN] Invalid request for initial order creation
System.ArgumentException: Payment amount must be greater than zero (Parameter 'amount')
   at Domain.Aggregates.OrderAggregate.ValidatePaymentRequest(Decimal amount) in /Users/tostyle/Project/Kingpower/poc/OrderDotnet/Domain/Aggregates/OrderAggregate.ProcessPayment.cs:line 96
   at Domain.Aggregates.OrderAggregate.ProcessPayment(PaymentMethod paymentMethod, Decimal amount, String currency) in /Users/tostyle/Project/Kingpower/poc/OrderDotnet/Domain/Aggregates/OrderAggregate.ProcessPayment.cs:line 20
   at Application.Services.OrderService.InitialOrderAsync(InitialOrderRequest request, CancellationToken cancellationToken) in /Users/tostyle/Project/Kingpower/poc/OrderDotnet/Application/Services/OrderService.cs:line 74
   at Application.UseCases.InitialOrderUseCase.ExecuteAsync(InitialOrderRequest request, CancellationToken cancellationToken) in /Users/tostyle/Project/Kingpower/poc/OrderDotnet/Application/UseCases/InitialOrderUseCase.cs:line 26
   at Api.Controllers.OrdersController.CreateInitialOrder(InitialOrderRequest request, CancellationToken cancellationToken) in /Users/tostyle/Project/Kingpower/poc/OrderDotnet/Api/Controllers/OrdersController.cs:line 50
2025-06-28 22:26:14.836 +07:00 [INF] Executed action method Api.Controllers.OrdersController.CreateInitialOrder (Api), returned result Microsoft.AspNetCore.Mvc.BadRequestObjectResult in 146.7435ms.
2025-06-28 22:26:14.840 +07:00 [INF] Executing BadRequestObjectResult, writing value of type '<>f__AnonymousType1`1[[System.String, System.Private.CoreLib, Version=9.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-06-28 22:26:14.848 +07:00 [INF] Executed action Api.Controllers.OrdersController.CreateInitialOrder (Api) in 667.9986ms
2025-06-28 22:26:14.848 +07:00 [INF] Executed endpoint 'Api.Controllers.OrdersController.CreateInitialOrder (Api)'
2025-06-28 22:26:14.849 +07:00 [INF] HTTP POST /api/orders responded 400 in 697.7618 ms
2025-06-28 22:26:14.851 +07:00 [INF] Request finished HTTP/1.1 POST http://localhost:5208/api/orders - 400 null application/json; charset=utf-8 720.9538ms
2025-06-28 22:27:55.637 +07:00 [INF] Application is shutting down...
2025-06-28 22:29:15.466 +07:00 [INF] Executed DbCommand (20ms) [Parameters=[], CommandType='"Text"', CommandTimeout='30']
SELECT CASE WHEN COUNT(*) = 0 THEN FALSE ELSE TRUE END
FROM pg_class AS cls
JOIN pg_namespace AS ns ON ns.oid = cls.relnamespace
WHERE
        cls.relkind IN ('r', 'v', 'm', 'f', 'p') AND
        ns.nspname NOT IN ('pg_catalog', 'information_schema') AND
        -- Exclude tables which are members of PG extensions
        NOT EXISTS (
            SELECT 1 FROM pg_depend WHERE
                classid=(
                    SELECT cls.oid
                    FROM pg_class AS cls
                             JOIN pg_namespace AS ns ON ns.oid = cls.relnamespace
                    WHERE relname='pg_class' AND ns.nspname='pg_catalog'
                ) AND
                objid=cls.oid AND
                deptype IN ('e', 'x')
        )
2025-06-28 22:29:15.490 +07:00 [INF] Order Management API starting up...
2025-06-28 22:29:15.490 +07:00 [INF] Available endpoints:
2025-06-28 22:29:15.491 +07:00 [INF]   API endpoints have been removed - controller is empty
2025-06-28 22:29:15.538 +07:00 [INF] Now listening on: http://localhost:5208
2025-06-28 22:29:15.539 +07:00 [INF] Application started. Press Ctrl+C to shut down.
2025-06-28 22:29:15.539 +07:00 [INF] Hosting environment: Development
2025-06-28 22:29:15.539 +07:00 [INF] Content root path: /Users/tostyle/Project/Kingpower/poc/OrderDotnet/Api
2025-06-28 22:29:22.252 +07:00 [INF] Request starting HTTP/1.1 POST http://localhost:5208/api/orders - application/json 62
2025-06-28 22:29:22.270 +07:00 [WRN] Failed to determine the https port for redirect.
2025-06-28 22:29:22.271 +07:00 [INF] Executing endpoint 'Api.Controllers.OrdersController.CreateInitialOrder (Api)'
2025-06-28 22:29:22.285 +07:00 [INF] Route matched with {action = "CreateInitialOrder", controller = "Orders"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.ActionResult`1[Application.DTOs.InitialOrderResponse]] CreateInitialOrder(Application.DTOs.InitialOrderRequest, System.Threading.CancellationToken) on controller Api.Controllers.OrdersController (Api).
2025-06-28 22:29:22.365 +07:00 [INF] Executing action method Api.Controllers.OrdersController.CreateInitialOrder (Api) - Validation state: "Valid"
2025-06-28 22:29:22.366 +07:00 [INF] Creating initial order with ReferenceId: order-ref-001
2025-06-28 22:29:22.494 +07:00 [INF] Executed DbCommand (10ms) [Parameters=[@__referenceId_0='?'], CommandType='"Text"', CommandTimeout='30']
SELECT o."Id", o."CreatedAt", o."OrderState", o."ReferenceId", o."UpdatedAt", o."Version", o."WorkflowId"
FROM "Orders" AS o
WHERE o."ReferenceId" = @__referenceId_0
LIMIT 1
2025-06-28 22:29:22.556 +07:00 [INF] Executed DbCommand (15ms) [Parameters=[@p0='?' (DbType = Guid), @p1='?' (DbType = DateTime), @p2='?' (DbType = Int32), @p3='?', @p4='?' (DbType = DateTime), @p5='?' (DbType = Int64), @p6='?'], CommandType='"Text"', CommandTimeout='30']
INSERT INTO "Orders" ("Id", "CreatedAt", "OrderState", "ReferenceId", "UpdatedAt", "Version", "WorkflowId")
VALUES (@p0, @p1, @p2, @p3, @p4, @p5, @p6);
2025-06-28 22:29:22.580 +07:00 [INF] Executed DbCommand (8ms) [Parameters=[@p0='?' (DbType = Guid), @p1='?' (DbType = Decimal), @p2='?', @p3='?', @p4='?' (DbType = Guid), @p5='?' (DbType = DateTime), @p6='?', @p7='?', @p8='?'], CommandType='"Text"', CommandTimeout='30']
INSERT INTO "OrderPayments" ("Id", "Amount", "Currency", "Notes", "OrderId", "PaidDate", "PaymentMethod", "Status", "TransactionReference")
VALUES (@p0, @p1, @p2, @p3, @p4, @p5, @p6, @p7, @p8);
2025-06-28 22:29:22.581 +07:00 [INF] Successfully created initial order with OrderId: "4a64b2f6-7bc5-4770-8d2b-975c840b174d"
2025-06-28 22:29:22.644 +07:00 [INF] Started OrderProcessingWorkflow with WorkflowId: order-processing-4a64b2f6-7bc5-4770-8d2b-975c840b174d for OrderId: "4a64b2f6-7bc5-4770-8d2b-975c840b174d"
2025-06-28 22:29:22.647 +07:00 [INF] Executed action method Api.Controllers.OrdersController.CreateInitialOrder (Api), returned result Microsoft.AspNetCore.Mvc.CreatedAtActionResult in 280.0011ms.
2025-06-28 22:29:22.652 +07:00 [INF] Executing CreatedAtActionResult, writing value of type 'Application.DTOs.InitialOrderResponse'.
2025-06-28 22:29:22.668 +07:00 [INF] Executed action Api.Controllers.OrdersController.CreateInitialOrder (Api) in 380.8964ms
2025-06-28 22:29:22.668 +07:00 [INF] Executed endpoint 'Api.Controllers.OrdersController.CreateInitialOrder (Api)'
2025-06-28 22:29:22.669 +07:00 [INF] HTTP POST /api/orders responded 201 in 400.5513 ms
2025-06-28 22:29:22.672 +07:00 [INF] Request finished HTTP/1.1 POST http://localhost:5208/api/orders - 201 null application/json; charset=utf-8 420.6683ms
2025-06-28 22:30:25.787 +07:00 [INF] Application is shutting down...
2025-06-28 22:30:29.359 +07:00 [INF] Executed DbCommand (20ms) [Parameters=[], CommandType='"Text"', CommandTimeout='30']
SELECT CASE WHEN COUNT(*) = 0 THEN FALSE ELSE TRUE END
FROM pg_class AS cls
JOIN pg_namespace AS ns ON ns.oid = cls.relnamespace
WHERE
        cls.relkind IN ('r', 'v', 'm', 'f', 'p') AND
        ns.nspname NOT IN ('pg_catalog', 'information_schema') AND
        -- Exclude tables which are members of PG extensions
        NOT EXISTS (
            SELECT 1 FROM pg_depend WHERE
                classid=(
                    SELECT cls.oid
                    FROM pg_class AS cls
                             JOIN pg_namespace AS ns ON ns.oid = cls.relnamespace
                    WHERE relname='pg_class' AND ns.nspname='pg_catalog'
                ) AND
                objid=cls.oid AND
                deptype IN ('e', 'x')
        )
2025-06-28 22:30:29.383 +07:00 [INF] Order Management API starting up...
2025-06-28 22:30:29.383 +07:00 [INF] Available endpoints:
2025-06-28 22:30:29.383 +07:00 [INF]   API endpoints have been removed - controller is empty
2025-06-28 22:30:29.425 +07:00 [INF] Now listening on: http://localhost:5208
2025-06-28 22:30:29.426 +07:00 [INF] Application started. Press Ctrl+C to shut down.
2025-06-28 22:30:29.426 +07:00 [INF] Hosting environment: Development
2025-06-28 22:30:29.426 +07:00 [INF] Content root path: /Users/tostyle/Project/Kingpower/poc/OrderDotnet/Api
2025-06-28 22:46:30.894 +07:00 [INF] Request starting HTTP/1.1 POST http://localhost:5208/api/orders/550e8400-e29b-41d4-a716-446655440000/payment - application/json 32
2025-06-28 22:46:30.941 +07:00 [WRN] Failed to determine the https port for redirect.
2025-06-28 22:46:30.948 +07:00 [INF] Executing endpoint 'Api.Controllers.OrdersController.ProcessPayment (Api)'
2025-06-28 22:46:30.986 +07:00 [INF] Route matched with {action = "ProcessPayment", controller = "Orders"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.ActionResult] ProcessPayment(System.Guid, Application.DTOs.ProcessPaymentSignalRequest, System.Threading.CancellationToken) on controller Api.Controllers.OrdersController (Api).
2025-06-28 22:46:31.492 +07:00 [INF] Executing action method Api.Controllers.OrdersController.ProcessPayment (Api) - Validation state: "Valid"
2025-06-28 22:46:31.493 +07:00 [INF] Processing payment for order "550e8400-e29b-41d4-a716-446655440000" with payment ID: payment-123
2025-06-28 22:46:31.644 +07:00 [INF] Executed DbCommand (9ms) [Parameters=[@__orderId_0='?' (DbType = Guid)], CommandType='"Text"', CommandTimeout='30']
SELECT o."Id", o."CreatedAt", o."OrderState", o."ReferenceId", o."UpdatedAt", o."Version", o."WorkflowId"
FROM "Orders" AS o
WHERE o."Id" = @__orderId_0
LIMIT 1
2025-06-28 22:46:31.647 +07:00 [WRN] Order "550e8400-e29b-41d4-a716-446655440000" not found
System.InvalidOperationException: Order 550e8400-e29b-41d4-a716-446655440000 not found
   at Application.Services.OrderService.GetOrderDetailsAsync(Guid orderId, CancellationToken cancellationToken)
   at Api.Controllers.OrdersController.ProcessPayment(Guid orderId, ProcessPaymentSignalRequest request, CancellationToken cancellationToken) in /Users/tostyle/Project/Kingpower/poc/OrderDotnet/Api/Controllers/OrdersController.cs:line 102
2025-06-28 22:46:31.655 +07:00 [INF] Executed action method Api.Controllers.OrdersController.ProcessPayment (Api), returned result Microsoft.AspNetCore.Mvc.NotFoundObjectResult in 161.6137ms.
2025-06-28 22:46:31.658 +07:00 [INF] Executing NotFoundObjectResult, writing value of type '<>f__AnonymousType1`1[[System.String, System.Private.CoreLib, Version=9.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-06-28 22:46:31.665 +07:00 [INF] Executed action Api.Controllers.OrdersController.ProcessPayment (Api) in 676.5057ms
2025-06-28 22:46:31.665 +07:00 [INF] Executed endpoint 'Api.Controllers.OrdersController.ProcessPayment (Api)'
2025-06-28 22:46:31.667 +07:00 [INF] HTTP POST /api/orders/550e8400-e29b-41d4-a716-446655440000/payment responded 404 in 726.3362 ms
2025-06-28 22:46:31.669 +07:00 [INF] Request finished HTTP/1.1 POST http://localhost:5208/api/orders/550e8400-e29b-41d4-a716-446655440000/payment - 404 null application/json; charset=utf-8 777.4034ms
2025-06-28 22:47:07.939 +07:00 [INF] Request starting HTTP/1.1 POST http://localhost:5208/api/orders/4a64b2f6-7bc5-4770-8d2b-975c840b174d/payment - application/json 32
2025-06-28 22:47:07.954 +07:00 [INF] Executing endpoint 'Api.Controllers.OrdersController.ProcessPayment (Api)'
2025-06-28 22:47:07.955 +07:00 [INF] Route matched with {action = "ProcessPayment", controller = "Orders"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.ActionResult] ProcessPayment(System.Guid, Application.DTOs.ProcessPaymentSignalRequest, System.Threading.CancellationToken) on controller Api.Controllers.OrdersController (Api).
2025-06-28 22:47:07.978 +07:00 [INF] Executing action method Api.Controllers.OrdersController.ProcessPayment (Api) - Validation state: "Valid"
2025-06-28 22:47:07.979 +07:00 [INF] Processing payment for order "4a64b2f6-7bc5-4770-8d2b-975c840b174d" with payment ID: payment-123
2025-06-28 22:47:08.029 +07:00 [INF] Executed DbCommand (7ms) [Parameters=[@__orderId_0='?' (DbType = Guid)], CommandType='"Text"', CommandTimeout='30']
SELECT o."Id", o."CreatedAt", o."OrderState", o."ReferenceId", o."UpdatedAt", o."Version", o."WorkflowId"
FROM "Orders" AS o
WHERE o."Id" = @__orderId_0
LIMIT 1
2025-06-28 22:47:08.068 +07:00 [ERR] An exception occurred while iterating over the results of a query for context type 'Infrastructure.Data.OrderDbContext'.
System.InvalidOperationException: A second operation was started on this context instance before a previous operation completed. This is usually caused by different threads concurrently using the same instance of DbContext. For more information on how to avoid threading issues with DbContext, see https://go.microsoft.com/fwlink/?linkid=2097913.
   at Microsoft.EntityFrameworkCore.Infrastructure.Internal.ConcurrencyDetector.EnterCriticalSection()
   at Microsoft.EntityFrameworkCore.Query.Internal.SingleQueryingEnumerable`1.AsyncEnumerator.MoveNextAsync()
System.InvalidOperationException: A second operation was started on this context instance before a previous operation completed. This is usually caused by different threads concurrently using the same instance of DbContext. For more information on how to avoid threading issues with DbContext, see https://go.microsoft.com/fwlink/?linkid=2097913.
   at Microsoft.EntityFrameworkCore.Infrastructure.Internal.ConcurrencyDetector.EnterCriticalSection()
   at Microsoft.EntityFrameworkCore.Query.Internal.SingleQueryingEnumerable`1.AsyncEnumerator.MoveNextAsync()
2025-06-28 22:47:08.072 +07:00 [ERR] An exception occurred while iterating over the results of a query for context type 'Infrastructure.Data.OrderDbContext'.
System.InvalidOperationException: A second operation was started on this context instance before a previous operation completed. This is usually caused by different threads concurrently using the same instance of DbContext. For more information on how to avoid threading issues with DbContext, see https://go.microsoft.com/fwlink/?linkid=2097913.
   at Microsoft.EntityFrameworkCore.Infrastructure.Internal.ConcurrencyDetector.EnterCriticalSection()
   at Microsoft.EntityFrameworkCore.Query.Internal.SingleQueryingEnumerable`1.AsyncEnumerator.MoveNextAsync()
System.InvalidOperationException: A second operation was started on this context instance before a previous operation completed. This is usually caused by different threads concurrently using the same instance of DbContext. For more information on how to avoid threading issues with DbContext, see https://go.microsoft.com/fwlink/?linkid=2097913.
   at Microsoft.EntityFrameworkCore.Infrastructure.Internal.ConcurrencyDetector.EnterCriticalSection()
   at Microsoft.EntityFrameworkCore.Query.Internal.SingleQueryingEnumerable`1.AsyncEnumerator.MoveNextAsync()
2025-06-28 22:47:08.073 +07:00 [INF] Executed DbCommand (11ms) [Parameters=[@__orderId_0='?' (DbType = Guid)], CommandType='"Text"', CommandTimeout='30']
SELECT o."Id", o."Description", o."ExternalTransactionId", o."OrderId", o."Points", o."TransactionDate", o."TransactionType"
FROM "OrderLoyaltyTransactions" AS o
WHERE o."OrderId" = @__orderId_0
ORDER BY o."TransactionDate" DESC
2025-06-28 22:47:08.073 +07:00 [WRN] Order "4a64b2f6-7bc5-4770-8d2b-975c840b174d" not found
System.InvalidOperationException: A second operation was started on this context instance before a previous operation completed. This is usually caused by different threads concurrently using the same instance of DbContext. For more information on how to avoid threading issues with DbContext, see https://go.microsoft.com/fwlink/?linkid=2097913.
   at Microsoft.EntityFrameworkCore.Infrastructure.Internal.ConcurrencyDetector.EnterCriticalSection()
   at Microsoft.EntityFrameworkCore.Query.Internal.SingleQueryingEnumerable`1.AsyncEnumerator.MoveNextAsync()
   at Microsoft.EntityFrameworkCore.EntityFrameworkQueryableExtensions.ToListAsync[TSource](IQueryable`1 source, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.EntityFrameworkQueryableExtensions.ToListAsync[TSource](IQueryable`1 source, CancellationToken cancellationToken)
   at Infrastructure.Repositories.OrderPaymentRepository.GetByOrderIdAsync(OrderId orderId, CancellationToken cancellationToken) in /Users/tostyle/Project/Kingpower/poc/OrderDotnet/Infrastructure/Repositories/OrderPaymentRepository.cs:line 29
   at Application.Services.OrderService.GetOrderDetailsAsync(Guid orderId, CancellationToken cancellationToken)
   at Api.Controllers.OrdersController.ProcessPayment(Guid orderId, ProcessPaymentSignalRequest request, CancellationToken cancellationToken) in /Users/tostyle/Project/Kingpower/poc/OrderDotnet/Api/Controllers/OrdersController.cs:line 102
2025-06-28 22:47:08.075 +07:00 [INF] Executed action method Api.Controllers.OrdersController.ProcessPayment (Api), returned result Microsoft.AspNetCore.Mvc.NotFoundObjectResult in 96.5466ms.
2025-06-28 22:47:08.075 +07:00 [INF] Executing NotFoundObjectResult, writing value of type '<>f__AnonymousType1`1[[System.String, System.Private.CoreLib, Version=9.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-06-28 22:47:08.076 +07:00 [INF] Executed action Api.Controllers.OrdersController.ProcessPayment (Api) in 120.5432ms
2025-06-28 22:47:08.076 +07:00 [INF] Executed endpoint 'Api.Controllers.OrdersController.ProcessPayment (Api)'
2025-06-28 22:47:08.076 +07:00 [INF] HTTP POST /api/orders/4a64b2f6-7bc5-4770-8d2b-975c840b174d/payment responded 404 in 124.0195 ms
2025-06-28 22:47:08.076 +07:00 [INF] Request finished HTTP/1.1 POST http://localhost:5208/api/orders/4a64b2f6-7bc5-4770-8d2b-975c840b174d/payment - 404 null application/json; charset=utf-8 139.17ms
2025-06-28 22:48:01.258 +07:00 [INF] Application is shutting down...
2025-06-28 22:48:06.120 +07:00 [INF] Executed DbCommand (23ms) [Parameters=[], CommandType='"Text"', CommandTimeout='30']
SELECT CASE WHEN COUNT(*) = 0 THEN FALSE ELSE TRUE END
FROM pg_class AS cls
JOIN pg_namespace AS ns ON ns.oid = cls.relnamespace
WHERE
        cls.relkind IN ('r', 'v', 'm', 'f', 'p') AND
        ns.nspname NOT IN ('pg_catalog', 'information_schema') AND
        -- Exclude tables which are members of PG extensions
        NOT EXISTS (
            SELECT 1 FROM pg_depend WHERE
                classid=(
                    SELECT cls.oid
                    FROM pg_class AS cls
                             JOIN pg_namespace AS ns ON ns.oid = cls.relnamespace
                    WHERE relname='pg_class' AND ns.nspname='pg_catalog'
                ) AND
                objid=cls.oid AND
                deptype IN ('e', 'x')
        )
2025-06-28 22:48:06.143 +07:00 [INF] Order Management API starting up...
2025-06-28 22:48:06.144 +07:00 [INF] Available endpoints:
2025-06-28 22:48:06.144 +07:00 [INF]   API endpoints have been removed - controller is empty
2025-06-28 22:48:06.187 +07:00 [INF] Now listening on: http://localhost:5208
2025-06-28 22:48:06.187 +07:00 [INF] Application started. Press Ctrl+C to shut down.
2025-06-28 22:48:06.187 +07:00 [INF] Hosting environment: Development
2025-06-28 22:48:06.188 +07:00 [INF] Content root path: /Users/tostyle/Project/Kingpower/poc/OrderDotnet/Api
2025-06-28 22:48:15.863 +07:00 [INF] Request starting HTTP/1.1 POST http://localhost:5208/api/orders/4a64b2f6-7bc5-4770-8d2b-975c840b174d/payment - application/json 32
2025-06-28 22:48:15.882 +07:00 [WRN] Failed to determine the https port for redirect.
2025-06-28 22:48:15.886 +07:00 [INF] Executing endpoint 'Api.Controllers.OrdersController.ProcessPayment (Api)'
2025-06-28 22:48:15.905 +07:00 [INF] Route matched with {action = "ProcessPayment", controller = "Orders"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.ActionResult] ProcessPayment(System.Guid, Application.DTOs.ProcessPaymentSignalRequest, System.Threading.CancellationToken) on controller Api.Controllers.OrdersController (Api).
2025-06-28 22:48:15.986 +07:00 [INF] Executing action method Api.Controllers.OrdersController.ProcessPayment (Api) - Validation state: "Valid"
2025-06-28 22:48:15.987 +07:00 [INF] Processing payment for order "4a64b2f6-7bc5-4770-8d2b-975c840b174d" with payment ID: payment-123
2025-06-28 22:48:16.144 +07:00 [INF] Executed DbCommand (12ms) [Parameters=[@__orderId_0='?' (DbType = Guid)], CommandType='"Text"', CommandTimeout='30']
SELECT o."Id", o."CreatedAt", o."OrderState", o."ReferenceId", o."UpdatedAt", o."Version", o."WorkflowId"
FROM "Orders" AS o
WHERE o."Id" = @__orderId_0
LIMIT 1
2025-06-28 22:48:16.189 +07:00 [INF] Executed DbCommand (3ms) [Parameters=[@__orderId_0='?' (DbType = Guid)], CommandType='"Text"', CommandTimeout='30']
SELECT o."Id", o."Description", o."ExternalTransactionId", o."OrderId", o."Points", o."TransactionDate", o."TransactionType"
FROM "OrderLoyaltyTransactions" AS o
WHERE o."OrderId" = @__orderId_0
ORDER BY o."TransactionDate" DESC
2025-06-28 22:48:16.194 +07:00 [INF] Executed DbCommand (2ms) [Parameters=[@__orderId_0='?' (DbType = Guid)], CommandType='"Text"', CommandTimeout='30']
SELECT o."Id", o."Amount", o."Currency", o."Notes", o."OrderId", o."PaidDate", o."PaymentMethod", o."Status", o."TransactionReference"
FROM "OrderPayments" AS o
WHERE o."OrderId" = @__orderId_0
ORDER BY o."PaidDate" DESC
2025-06-28 22:48:16.200 +07:00 [ERR] An exception occurred while iterating over the results of a query for context type 'Infrastructure.Data.OrderDbContext'.
System.InvalidOperationException: A second operation was started on this context instance before a previous operation completed. This is usually caused by different threads concurrently using the same instance of DbContext. For more information on how to avoid threading issues with DbContext, see https://go.microsoft.com/fwlink/?linkid=2097913.
   at Microsoft.EntityFrameworkCore.Infrastructure.Internal.ConcurrencyDetector.EnterCriticalSection()
   at Microsoft.EntityFrameworkCore.Query.Internal.SingleQueryingEnumerable`1.AsyncEnumerator.MoveNextAsync()
System.InvalidOperationException: A second operation was started on this context instance before a previous operation completed. This is usually caused by different threads concurrently using the same instance of DbContext. For more information on how to avoid threading issues with DbContext, see https://go.microsoft.com/fwlink/?linkid=2097913.
   at Microsoft.EntityFrameworkCore.Infrastructure.Internal.ConcurrencyDetector.EnterCriticalSection()
   at Microsoft.EntityFrameworkCore.Query.Internal.SingleQueryingEnumerable`1.AsyncEnumerator.MoveNextAsync()
2025-06-28 22:48:16.206 +07:00 [WRN] Order "4a64b2f6-7bc5-4770-8d2b-975c840b174d" not found
System.InvalidOperationException: A second operation was started on this context instance before a previous operation completed. This is usually caused by different threads concurrently using the same instance of DbContext. For more information on how to avoid threading issues with DbContext, see https://go.microsoft.com/fwlink/?linkid=2097913.
   at Microsoft.EntityFrameworkCore.Infrastructure.Internal.ConcurrencyDetector.EnterCriticalSection()
   at Microsoft.EntityFrameworkCore.Query.Internal.SingleQueryingEnumerable`1.AsyncEnumerator.MoveNextAsync()
   at Microsoft.EntityFrameworkCore.EntityFrameworkQueryableExtensions.ToListAsync[TSource](IQueryable`1 source, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.EntityFrameworkQueryableExtensions.ToListAsync[TSource](IQueryable`1 source, CancellationToken cancellationToken)
   at Infrastructure.Repositories.OrderStockRepository.GetByOrderIdAsync(OrderId orderId, CancellationToken cancellationToken) in /Users/tostyle/Project/Kingpower/poc/OrderDotnet/Infrastructure/Repositories/OrderStockRepository.cs:line 29
   at Application.Services.OrderService.GetOrderDetailsAsync(Guid orderId, CancellationToken cancellationToken) in /Users/tostyle/Project/Kingpower/poc/OrderDotnet/Application/Services/OrderService.cs:line 270
   at Api.Controllers.OrdersController.ProcessPayment(Guid orderId, ProcessPaymentSignalRequest request, CancellationToken cancellationToken) in /Users/tostyle/Project/Kingpower/poc/OrderDotnet/Api/Controllers/OrdersController.cs:line 102
2025-06-28 22:48:16.210 +07:00 [INF] Executed action method Api.Controllers.OrdersController.ProcessPayment (Api), returned result Microsoft.AspNetCore.Mvc.NotFoundObjectResult in 222.4204ms.
2025-06-28 22:48:16.214 +07:00 [INF] Executing NotFoundObjectResult, writing value of type '<>f__AnonymousType1`1[[System.String, System.Private.CoreLib, Version=9.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-06-28 22:48:16.221 +07:00 [INF] Executed action Api.Controllers.OrdersController.ProcessPayment (Api) in 314.5512ms
2025-06-28 22:48:16.221 +07:00 [INF] Executed endpoint 'Api.Controllers.OrdersController.ProcessPayment (Api)'
2025-06-28 22:48:16.222 +07:00 [INF] HTTP POST /api/orders/4a64b2f6-7bc5-4770-8d2b-975c840b174d/payment responded 404 in 340.9123 ms
2025-06-28 22:48:16.224 +07:00 [INF] Request finished HTTP/1.1 POST http://localhost:5208/api/orders/4a64b2f6-7bc5-4770-8d2b-975c840b174d/payment - 404 null application/json; charset=utf-8 361.8193ms
2025-06-28 22:49:50.365 +07:00 [INF] Application is shutting down...
2025-06-28 22:49:53.133 +07:00 [INF] Executed DbCommand (26ms) [Parameters=[], CommandType='"Text"', CommandTimeout='30']
SELECT CASE WHEN COUNT(*) = 0 THEN FALSE ELSE TRUE END
FROM pg_class AS cls
JOIN pg_namespace AS ns ON ns.oid = cls.relnamespace
WHERE
        cls.relkind IN ('r', 'v', 'm', 'f', 'p') AND
        ns.nspname NOT IN ('pg_catalog', 'information_schema') AND
        -- Exclude tables which are members of PG extensions
        NOT EXISTS (
            SELECT 1 FROM pg_depend WHERE
                classid=(
                    SELECT cls.oid
                    FROM pg_class AS cls
                             JOIN pg_namespace AS ns ON ns.oid = cls.relnamespace
                    WHERE relname='pg_class' AND ns.nspname='pg_catalog'
                ) AND
                objid=cls.oid AND
                deptype IN ('e', 'x')
        )
2025-06-28 22:49:53.157 +07:00 [INF] Order Management API starting up...
2025-06-28 22:49:53.157 +07:00 [INF] Available endpoints:
2025-06-28 22:49:53.157 +07:00 [INF]   API endpoints have been removed - controller is empty
2025-06-28 22:49:53.206 +07:00 [INF] Now listening on: http://localhost:5208
2025-06-28 22:49:53.206 +07:00 [INF] Application started. Press Ctrl+C to shut down.
2025-06-28 22:49:53.207 +07:00 [INF] Hosting environment: Development
2025-06-28 22:49:53.207 +07:00 [INF] Content root path: /Users/tostyle/Project/Kingpower/poc/OrderDotnet/Api
2025-06-28 22:50:03.081 +07:00 [INF] Request starting HTTP/1.1 POST http://localhost:5208/api/orders/4a64b2f6-7bc5-4770-8d2b-975c840b174d/payment - application/json 32
2025-06-28 22:50:03.098 +07:00 [WRN] Failed to determine the https port for redirect.
2025-06-28 22:50:03.101 +07:00 [INF] Executing endpoint 'Api.Controllers.OrdersController.ProcessPayment (Api)'
2025-06-28 22:50:03.129 +07:00 [INF] Route matched with {action = "ProcessPayment", controller = "Orders"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.ActionResult] ProcessPayment(System.Guid, Application.DTOs.ProcessPaymentSignalRequest, System.Threading.CancellationToken) on controller Api.Controllers.OrdersController (Api).
2025-06-28 22:50:03.205 +07:00 [INF] Executing action method Api.Controllers.OrdersController.ProcessPayment (Api) - Validation state: "Valid"
2025-06-28 22:50:03.206 +07:00 [INF] Processing payment for order "4a64b2f6-7bc5-4770-8d2b-975c840b174d" with payment ID: payment-123
2025-06-28 22:50:03.345 +07:00 [INF] Executed DbCommand (18ms) [Parameters=[@__orderId_0='?' (DbType = Guid)], CommandType='"Text"', CommandTimeout='30']
SELECT o."Id", o."CreatedAt", o."OrderState", o."ReferenceId", o."UpdatedAt", o."Version", o."WorkflowId"
FROM "Orders" AS o
WHERE o."Id" = @__orderId_0
LIMIT 1
2025-06-28 22:50:03.377 +07:00 [INF] Executed DbCommand (6ms) [Parameters=[@__orderId_0='?' (DbType = Guid)], CommandType='"Text"', CommandTimeout='30']
SELECT o."Id", o."Description", o."ExternalTransactionId", o."OrderId", o."Points", o."TransactionDate", o."TransactionType"
FROM "OrderLoyaltyTransactions" AS o
WHERE o."OrderId" = @__orderId_0
ORDER BY o."TransactionDate" DESC
2025-06-28 22:50:03.384 +07:00 [INF] Executed DbCommand (2ms) [Parameters=[@__orderId_0='?' (DbType = Guid)], CommandType='"Text"', CommandTimeout='30']
SELECT o."Id", o."Amount", o."Currency", o."Notes", o."OrderId", o."PaidDate", o."PaymentMethod", o."Status", o."TransactionReference"
FROM "OrderPayments" AS o
WHERE o."OrderId" = @__orderId_0
ORDER BY o."PaidDate" DESC
2025-06-28 22:50:03.406 +07:00 [INF] Executed DbCommand (7ms) [Parameters=[@__orderId_0='?' (DbType = Guid)], CommandType='"Text"', CommandTimeout='30']
SELECT o."Id", o."ExpirationDate", o."ExternalReservationId", o."Notes", o."OrderId", o."ProductId", o."QuantityReserved", o."ReservationDate", o."Status"
FROM "OrderStockReservations" AS o
WHERE o."OrderId" = @__orderId_0
ORDER BY o."ReservationDate" DESC
2025-06-28 22:50:03.451 +07:00 [INF] Successfully sent payment success signal to workflow order-processing-4a64b2f6-7bc5-4770-8d2b-975c840b174d for order "4a64b2f6-7bc5-4770-8d2b-975c840b174d"
2025-06-28 22:50:03.453 +07:00 [INF] Executed action method Api.Controllers.OrdersController.ProcessPayment (Api), returned result Microsoft.AspNetCore.Mvc.OkObjectResult in 245.5674ms.
2025-06-28 22:50:03.462 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType2`2[[System.String, System.Private.CoreLib, Version=9.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e],[System.String, System.Private.CoreLib, Version=9.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-06-28 22:50:03.473 +07:00 [INF] Executed action Api.Controllers.OrdersController.ProcessPayment (Api) in 342.3596ms
2025-06-28 22:50:03.473 +07:00 [INF] Executed endpoint 'Api.Controllers.OrdersController.ProcessPayment (Api)'
2025-06-28 22:50:03.476 +07:00 [INF] HTTP POST /api/orders/4a64b2f6-7bc5-4770-8d2b-975c840b174d/payment responded 200 in 378.1325 ms
2025-06-28 22:50:03.479 +07:00 [INF] Request finished HTTP/1.1 POST http://localhost:5208/api/orders/4a64b2f6-7bc5-4770-8d2b-975c840b174d/payment - 200 null application/json; charset=utf-8 398.7635ms
2025-06-28 22:50:25.071 +07:00 [INF] Request starting HTTP/1.1 POST http://localhost:5208/api/orders - application/json 62
2025-06-28 22:50:25.082 +07:00 [INF] Executing endpoint 'Api.Controllers.OrdersController.CreateInitialOrder (Api)'
2025-06-28 22:50:25.097 +07:00 [INF] Route matched with {action = "CreateInitialOrder", controller = "Orders"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.ActionResult`1[Application.DTOs.InitialOrderResponse]] CreateInitialOrder(Application.DTOs.InitialOrderRequest, System.Threading.CancellationToken) on controller Api.Controllers.OrdersController (Api).
2025-06-28 22:50:25.117 +07:00 [INF] Executing action method Api.Controllers.OrdersController.CreateInitialOrder (Api) - Validation state: "Valid"
2025-06-28 22:50:25.120 +07:00 [INF] Creating initial order with ReferenceId: order-ref-002
2025-06-28 22:50:25.164 +07:00 [INF] Executed DbCommand (12ms) [Parameters=[@__referenceId_0='?'], CommandType='"Text"', CommandTimeout='30']
SELECT o."Id", o."CreatedAt", o."OrderState", o."ReferenceId", o."UpdatedAt", o."Version", o."WorkflowId"
FROM "Orders" AS o
WHERE o."ReferenceId" = @__referenceId_0
LIMIT 1
2025-06-28 22:50:25.207 +07:00 [INF] Executed DbCommand (8ms) [Parameters=[@p0='?' (DbType = Guid), @p1='?' (DbType = DateTime), @p2='?' (DbType = Int32), @p3='?', @p4='?' (DbType = DateTime), @p5='?' (DbType = Int64), @p6='?'], CommandType='"Text"', CommandTimeout='30']
INSERT INTO "Orders" ("Id", "CreatedAt", "OrderState", "ReferenceId", "UpdatedAt", "Version", "WorkflowId")
VALUES (@p0, @p1, @p2, @p3, @p4, @p5, @p6);
2025-06-28 22:50:25.220 +07:00 [INF] Executed DbCommand (4ms) [Parameters=[@p0='?' (DbType = Guid), @p1='?' (DbType = Decimal), @p2='?', @p3='?', @p4='?' (DbType = Guid), @p5='?' (DbType = DateTime), @p6='?', @p7='?', @p8='?'], CommandType='"Text"', CommandTimeout='30']
INSERT INTO "OrderPayments" ("Id", "Amount", "Currency", "Notes", "OrderId", "PaidDate", "PaymentMethod", "Status", "TransactionReference")
VALUES (@p0, @p1, @p2, @p3, @p4, @p5, @p6, @p7, @p8);
2025-06-28 22:50:25.221 +07:00 [INF] Successfully created initial order with OrderId: "ff688858-86dc-40b9-8fe7-bff65313258e"
2025-06-28 22:50:25.261 +07:00 [INF] Started OrderProcessingWorkflow with WorkflowId: order-processing-ff688858-86dc-40b9-8fe7-bff65313258e for OrderId: "ff688858-86dc-40b9-8fe7-bff65313258e"
2025-06-28 22:50:25.261 +07:00 [INF] Executed action method Api.Controllers.OrdersController.CreateInitialOrder (Api), returned result Microsoft.AspNetCore.Mvc.CreatedAtActionResult in 143.6781ms.
2025-06-28 22:50:25.261 +07:00 [INF] Executing CreatedAtActionResult, writing value of type 'Application.DTOs.InitialOrderResponse'.
2025-06-28 22:50:25.269 +07:00 [INF] Executed action Api.Controllers.OrdersController.CreateInitialOrder (Api) in 172.0108ms
2025-06-28 22:50:25.270 +07:00 [INF] Executed endpoint 'Api.Controllers.OrdersController.CreateInitialOrder (Api)'
2025-06-28 22:50:25.270 +07:00 [INF] HTTP POST /api/orders responded 201 in 191.2347 ms
2025-06-28 22:50:25.270 +07:00 [INF] Request finished HTTP/1.1 POST http://localhost:5208/api/orders - 201 null application/json; charset=utf-8 198.9436ms
2025-06-28 22:50:44.429 +07:00 [INF] Request starting HTTP/1.1 POST http://localhost:5208/api/orders/ff688858-86dc-40b9-8fe7-bff65313258e/cancel - application/json 2
2025-06-28 22:50:44.440 +07:00 [INF] Executing endpoint 'Api.Controllers.OrdersController.CancelOrder (Api)'
2025-06-28 22:50:44.461 +07:00 [INF] Route matched with {action = "CancelOrder", controller = "Orders"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.ActionResult] CancelOrder(System.Guid, System.Threading.CancellationToken) on controller Api.Controllers.OrdersController (Api).
2025-06-28 22:50:44.473 +07:00 [INF] Executing action method Api.Controllers.OrdersController.CancelOrder (Api) - Validation state: "Valid"
2025-06-28 22:50:44.477 +07:00 [INF] Cancelling order "ff688858-86dc-40b9-8fe7-bff65313258e"
2025-06-28 22:50:44.489 +07:00 [INF] Executed DbCommand (6ms) [Parameters=[@__orderId_0='?' (DbType = Guid)], CommandType='"Text"', CommandTimeout='30']
SELECT o."Id", o."CreatedAt", o."OrderState", o."ReferenceId", o."UpdatedAt", o."Version", o."WorkflowId"
FROM "Orders" AS o
WHERE o."Id" = @__orderId_0
LIMIT 1
2025-06-28 22:50:44.493 +07:00 [INF] Executed DbCommand (3ms) [Parameters=[@__orderId_0='?' (DbType = Guid)], CommandType='"Text"', CommandTimeout='30']
SELECT o."Id", o."Description", o."ExternalTransactionId", o."OrderId", o."Points", o."TransactionDate", o."TransactionType"
FROM "OrderLoyaltyTransactions" AS o
WHERE o."OrderId" = @__orderId_0
ORDER BY o."TransactionDate" DESC
2025-06-28 22:50:44.495 +07:00 [INF] Executed DbCommand (1ms) [Parameters=[@__orderId_0='?' (DbType = Guid)], CommandType='"Text"', CommandTimeout='30']
SELECT o."Id", o."Amount", o."Currency", o."Notes", o."OrderId", o."PaidDate", o."PaymentMethod", o."Status", o."TransactionReference"
FROM "OrderPayments" AS o
WHERE o."OrderId" = @__orderId_0
ORDER BY o."PaidDate" DESC
2025-06-28 22:50:44.496 +07:00 [INF] Executed DbCommand (1ms) [Parameters=[@__orderId_0='?' (DbType = Guid)], CommandType='"Text"', CommandTimeout='30']
SELECT o."Id", o."ExpirationDate", o."ExternalReservationId", o."Notes", o."OrderId", o."ProductId", o."QuantityReserved", o."ReservationDate", o."Status"
FROM "OrderStockReservations" AS o
WHERE o."OrderId" = @__orderId_0
ORDER BY o."ReservationDate" DESC
2025-06-28 22:50:44.502 +07:00 [INF] Successfully sent cancel signal to workflow order-processing-ff688858-86dc-40b9-8fe7-bff65313258e for order "ff688858-86dc-40b9-8fe7-bff65313258e"
2025-06-28 22:50:44.503 +07:00 [INF] Executed action method Api.Controllers.OrdersController.CancelOrder (Api), returned result Microsoft.AspNetCore.Mvc.OkObjectResult in 28.9897ms.
2025-06-28 22:50:44.503 +07:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType2`2[[System.String, System.Private.CoreLib, Version=9.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e],[System.String, System.Private.CoreLib, Version=9.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-06-28 22:50:44.503 +07:00 [INF] Executed action Api.Controllers.OrdersController.CancelOrder (Api) in 41.4289ms
2025-06-28 22:50:44.503 +07:00 [INF] Executed endpoint 'Api.Controllers.OrdersController.CancelOrder (Api)'
2025-06-28 22:50:44.503 +07:00 [INF] HTTP POST /api/orders/ff688858-86dc-40b9-8fe7-bff65313258e/cancel responded 200 in 64.4569 ms
2025-06-28 22:50:44.503 +07:00 [INF] Request finished HTTP/1.1 POST http://localhost:5208/api/orders/ff688858-86dc-40b9-8fe7-bff65313258e/cancel - 200 null application/json; charset=utf-8 74.9245ms
